services:
  coolify:
    image: ghcr.io/coollabsio/coolify:${COOLIFY_VERSION:?required}
    container_name: coolify
    restart: unless-stopped
    env_file: .env
    volumes:
      - ./.env:/var/www/html/.env
      - /var/run/docker.sock:/var/run/docker.sock
      - ./.docker/coolify/data/ssh:/var/www/html/storage/app/ssh
      - ./.docker/coolify/data/applications:/var/www/html/storage/app/applications
      - ./.docker/coolify/data/databases:/var/www/html/storage/app/databases
      - ./.docker/coolify/data/services:/var/www/html/storage/app/services
      - ./.docker/coolify/data/backups:/var/www/html/storage/app/backups
      - ./.docker/coolify/data/webhooks-during-maintenance:/var/www/html/storage/app/webhooks-during-maintenance
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - coolify
      - postgres-network
      - traefik-network
    depends_on:
      coolify-redis:
        condition: service_healthy
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-network

      - traefik.http.routers.coolify.rule=Host(`${COOLIFY_SERVER_HOSTNAME:?required}`)
      - traefik.http.routers.coolify.entrypoints=https
      - traefik.http.routers.coolify.tls.certresolver=cloudflare
      - traefik.http.routers.coolify.middlewares=trusted@file
      - traefik.http.routers.coolify.service=coolify
      - traefik.http.routers.coolify.priority=10

      - traefik.http.services.coolify.loadbalancer.server.port=8080
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  coolify-realtime:
    image: ghcr.io/coollabsio/coolify-realtime:1.0.10
    container_name: coolify-realtime
    restart: unless-stopped
    env_file: .env
    environment:
      SOKETI_DEFAULT_APP_ID: ${PUSHER_APP_ID}
      SOKETI_DEFAULT_APP_KEY: ${PUSHER_APP_KEY}
      SOKETI_DEFAULT_APP_SECRET: ${PUSHER_APP_SECRET}
    volumes:
      - ./.docker/coolify/data/ssh:/var/www/html/storage/app/ssh:ro
    networks:
      - coolify
      - traefik-network
    depends_on:
      coolify:
        condition: service_healthy
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-network

      # Soketi WebSocket router — /app/ path
      - traefik.http.routers.coolify-realtime.rule=Host(`${COOLIFY_SERVER_HOSTNAME:?required}`) && PathPrefix(`/app/`)
      - traefik.http.routers.coolify-realtime.entrypoints=https
      - traefik.http.routers.coolify-realtime.tls.certresolver=letsencrypt
      - traefik.http.routers.coolify-realtime.service=coolify-realtime
      - traefik.http.routers.coolify-realtime.priority=20

      - traefik.http.services.coolify-realtime.loadbalancer.server.port=6001

      # Terminal WebSocket router — /terminal/ws path
      - traefik.http.routers.coolify-terminal.rule=Host(`${COOLIFY_SERVER_HOSTNAME:?required}`) && PathPrefix(`/terminal/ws`)
      - traefik.http.routers.coolify-terminal.entrypoints=https
      - traefik.http.routers.coolify-terminal.tls.certresolver=letsencrypt
      - traefik.http.routers.coolify-terminal.service=coolify-terminal
      - traefik.http.routers.coolify-terminal.priority=30

      - traefik.http.services.coolify-terminal.loadbalancer.server.port=6002
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f node > /dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  coolify-redis:
    image: redis:7-alpine
    container_name: coolify-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:?required} --save 60 1 --loglevel warning
    volumes:
      - coolify-redis-data:/data
    networks:
      - coolify
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s


volumes:
  coolify-redis-data:


networks:
  coolify:
    name: coolify
  postgres-network:
    external: true
  traefik-network:
    external: true
